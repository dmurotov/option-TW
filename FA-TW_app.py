import streamlit as st
import pandas as pd
import yfinance as yf
import requests
from io import BytesIO
from PIL import Image as PILImage
import plotly.graph_objects as go

st.set_page_config(page_title="–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ê–Ω–∞–ª–∏–∑", layout="wide")

st.title("üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ê–Ω–∞–ª–∏–∑ –ê–∫—Ü–∏–π")
ticker = st.text_input("–í–≤–µ–¥–∏—Ç–µ —Ç–∏–∫–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, AAPL):", value="AAPL").upper()

@st.cache_data(show_spinner=False)
def get_logo_url(info):
    website = info.get("website", "")
    domain = website.replace("https://", "").replace("http://", "").split("/")[0] if website else ""
    return f"https://logo.clearbit.com/{domain}" if domain else ""

@st.cache_data(show_spinner=False)
def get_extended_metrics():
    return [
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "P/E (TTM)", "–ó–Ω–∞—á–µ–Ω–∏–µ": "53.67", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Forward P/E", "–ó–Ω–∞—á–µ–Ω–∏–µ": "17.89", "–û—Ü–µ–Ω–∫–∞": "üü° –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "P/B", "–ó–Ω–∞—á–µ–Ω–∏–µ": "1.01", "–û—Ü–µ–Ω–∫–∞": "üü¢ –•–æ—Ä–æ—à–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "P/S", "–ó–Ω–∞—á–µ–Ω–∏–µ": "0.32", "–û—Ü–µ–Ω–∫–∞": "üü¢ –•–æ—Ä–æ—à–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "P/FCF", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–ù/–î (–æ—Ç—Ä–∏—Ü. FCF)", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "D/E", "–ó–Ω–∞—á–µ–Ω–∏–µ": "0.54", "–û—Ü–µ–Ω–∫–∞": "üü° –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "PEG Ratio", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–ù/–î", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Enterprise Value", "–ó–Ω–∞—á–µ–Ω–∏–µ": "~115 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üü¢ –•–æ—Ä–æ—à–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Peter Lynch Price (PLP)", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω", "–û—Ü–µ–Ω–∫–∞": "üîµ –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Piotroski F-Score", "–ó–Ω–∞—á–µ–Ω–∏–µ": "4 –∏–∑ 9", "–û—Ü–µ–Ω–∫–∞": "üü° –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Altman Z-Score", "–ó–Ω–∞—á–µ–Ω–∏–µ": "-0.75", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Beneish M-Score", "–ó–Ω–∞—á–µ–Ω–∏–µ": "-1.95", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Dividend Yield (%)", "–ó–Ω–∞—á–µ–Ω–∏–µ": "1.75%", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Payout Ratio", "–ó–Ω–∞—á–µ–Ω–∏–µ": "71.43%", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Dividend Growth 5Y", "–ó–Ω–∞—á–µ–Ω–∏–µ": "0%", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Quick Ratio", "–ó–Ω–∞—á–µ–Ω–∏–µ": "0.47", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Current Ratio", "–ó–Ω–∞—á–µ–Ω–∏–µ": "0.47", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Revenue (TTM)", "–ó–Ω–∞—á–µ–Ω–∏–µ": "$137.3 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Revenue –≤ –∫—Ä–∏–∑–∏—Å—ã", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–ü–∞–¥–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2020: $145 –º–ª–Ω)", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Operating Margin %", "–ó–Ω–∞—á–µ–Ω–∏–µ": "-2.52%", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Net Margin %", "–ó–Ω–∞—á–µ–Ω–∏–µ": "-1.84%", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Net Income", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–£–±—ã—Ç–æ–∫: -$2.53 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Total Debt", "–ó–Ω–∞—á–µ–Ω–∏–µ": "~25.6 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üü° –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Total Assets", "–ó–Ω–∞—á–µ–Ω–∏–µ": "$245 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Total Liabilities", "–ó–Ω–∞—á–µ–Ω–∏–µ": "$194 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Stockholders' Equity", "–ó–Ω–∞—á–µ–Ω–∏–µ": "$50.3 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "EPS Estimate (Next Year)", "–ó–Ω–∞—á–µ–Ω–∏–µ": "$0.20", "–û—Ü–µ–Ω–∫–∞": "üü¢ –•–æ—Ä–æ—à–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "ROE (TTM)", "–ó–Ω–∞—á–µ–Ω–∏–µ": "-4.87%", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Buyback (5Y)", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–ù–µ—Ç", "–û—Ü–µ–Ω–∫–∞": "üîµ –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "ROIC", "–ó–Ω–∞—á–µ–Ω–∏–µ": "-2.12%", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Operating CF", "–ó–Ω–∞—á–µ–Ω–∏–µ": "-$4.8 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Free CF", "–ó–Ω–∞—á–µ–Ω–∏–µ": "-$6.7 –º–ª–Ω", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Short Float", "–ó–Ω–∞—á–µ–Ω–∏–µ": "0.33%", "–û—Ü–µ–Ω–∫–∞": "üü¢ –•–æ—Ä–æ—à–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Institutional Ownership", "–ó–Ω–∞—á–µ–Ω–∏–µ": "38%", "–û—Ü–µ–Ω–∫–∞": "üü¢ –•–æ—Ä–æ—à–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Employees", "–ó–Ω–∞—á–µ–Ω–∏–µ": "92", "–û—Ü–µ–Ω–∫–∞": "üî¥ –ü–ª–æ—Ö–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Retail Stores", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–ù–µ—Ç", "–û—Ü–µ–Ω–∫–∞": "üîµ –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "OpenInsiders", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–ü–æ–∫—É–ø–∫–∞ (–ø–æ—Å–ª–µ–¥–Ω—è—è –≤ –º–∞—Ä—Ç–µ)", "–û—Ü–µ–Ω–∫–∞": "üü¢ –•–æ—Ä–æ—à–æ"},
        {"–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å": "Quant Rating", "–ó–Ω–∞—á–µ–Ω–∏–µ": "–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ", "–û—Ü–µ–Ω–∫–∞": "üîµ –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ"},
    ]

if ticker:
    with st.spinner("–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ..."):
        stock = yf.Ticker(ticker)
        info = stock.info
        data = get_extended_metrics()

    st.subheader(f"üìà –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è {ticker}")
    df = pd.DataFrame(data)
    st.dataframe(df, use_container_width=True)

    # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    numeric_df = df.copy()
    numeric_df['–ß–∏—Å–ª–æ'] = pd.to_numeric(
        numeric_df['–ó–Ω–∞—á–µ–Ω–∏–µ'].str.replace(r'[^\d\.-]', '', regex=True),
        errors='coerce'
    )
    numeric_df = numeric_df.dropna(subset=['–ß–∏—Å–ª–æ'])

    fig = go.Figure(go.Bar(
        x=numeric_df['–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å'],
        y=numeric_df['–ß–∏—Å–ª–æ'],
        marker_color='indigo'
    ))
    fig.update_layout(
        title=f"–ì—Ä–∞—Ñ–∏–∫ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π {ticker}",
        xaxis_title="–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å",
        yaxis_title="–ó–Ω–∞—á–µ–Ω–∏–µ",
        height=450
    )
    st.plotly_chart(fig, use_container_width=True)

    # –õ–æ–≥–æ—Ç–∏–ø
    logo_url = get_logo_url(info)
    if logo_url:
        try:
            response = requests.get(logo_url, timeout=3)
            img = PILImage.open(BytesIO(response.content))
            st.image(img, caption=f"–õ–æ–≥–æ—Ç–∏–ø {ticker}", width=150)
        except:
            st.info("‚ùó –õ–æ–≥–æ—Ç–∏–ø –Ω–µ –Ω–∞–π–¥–µ–Ω.")
